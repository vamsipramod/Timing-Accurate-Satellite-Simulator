

CXX = g++
CXX_ARGS = -std=c++17 -DNDEBUG -O3 -g 
RM= rm -f 
NANOLOG_RUNTIME_DIR= ./NanoLog/runtime
NANOLOG_LIB= ./NanoLog/runtime/libNanoLog.a

LIBELF_SRC_DIR= ./libelf/lib
LIBELF_LIB= ./libelf/lib/libelf.a
LIBELF_DIR= ./libelf

INCLUDES= -I$(NANOLOG_RUNTIME_DIR) -I$(LIBELF_SRC_DIR)
LIBS = -lelf -L -lNanoLog -pthread -lrt

all: libs satsim
libs: nano elf
nano:
ifneq ("$(wildcard $(NANOLOG_LIB))","./NanoLog/runtime/libNanoLog.a")
	$(wildcard $(NANOLOG_LIB))
	$(MAKE) -C $(NANOLOG_RUNTIME_DIR)
endif

elf:
ifneq ("$(wildcard $(LIBELF_LIB))","./libelf/lib/libelf.a")
	$(MAKE) -C $(LIBELF_DIR)
endif

OBJS = satsim.o core.o fetch.o decode.o execute.o reg_access.o mem_access.o exception.o write_back.o reg.o instruction.o elf_reader.o

$(OBJS): %o : %cpp
		$(CXX) $(INCLUDES) -c -o $@ $< $(LIBS)

satsim : $(OBJS)
		$(CXX) $(CXX_ARGS) $(INCLUDES) $(OBJS) $(NANOLOG_LIB) -o satsim $(LIBS)

clean :	
		$(RM) *.o *.log satsim

clean-all: clean
	$(RM) libNanoLog.a decompressor Makefile
	$(MAKE) clean-all -C $(NANOLOG_RUNTIME_DIR)
	$(MAKE) clean -C $(LIBELF_DIR)
